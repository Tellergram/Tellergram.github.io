<!DOCTYPE html>
<html>
<head>
    <title>Document Viewer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="normalize.css">
    <style>
        body {
            background-color: #EEE;
        }
        .app-container {
            margin-top: 0px !important;
            overflow: visible !important;
        }
        
        .doc {
            padding: 20px !important;
        }

        #content {
            margin: 0 auto;
        }
        
        .page {
            box-shadow: rgba(0, 0, 0, 0.28) 0px 0px 9px 0px;
            background-color: #FFF;
            margin: 10pt 0;
        }
        
        img {
            max-width: calc(100vw - 40px);
            height: initial !important;
        }
        
        span {
            width: initial !important;
            height: initial !important;
        }
        
        .hr {
            border-bottom: .75pt solid #888;
            margin: 7pt 0;
        }
        
        .message {
            display: block;
            height: 100vh;
            line-height:100vh;
            text-align:center;
        }
        
        .edit {
            position: absolute;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            background-color: rgba(136, 136, 136, 0.5);
            color: #FFF;
            top: 0;
            right: 0;
            border-radius: 0px 0px 0px 10px;
            -moz-border-radius: 0px 0px 0px 10px;
            -webkit-border-radius: 0px 0px 0px 10px;
            border: 0px solid #000000;
            text-decoration: none;
        }
        
        .edit:hover {
            background-color: rgba(52, 91, 138, 0.5);
        }
        
    </style>
    <script>
        function GET(parameter) {
            var re = new RegExp(parameter + '=([^&#=]*)'),
                match = re.exec(window.location.search);
            if (match) {
                return decodeURIComponent(match[1]);
            } else {
                return null;
            }
        }
    
        function fetch() {
            //Get source
            var src = GET('src');
            if (!src) return output('<span class="message">Error reading "src" parameter in URL.</span>');
            
            //Set edit button
            document.getElementsByClassName("edit")[0].setAttribute("href", "https://docs.google.com/document/d/" + src + "/edit");
            
            //Get width
            var width = GET('width');
            if (!width) width = 500;
            
            var css = '@media screen and (min-width: ' + width + 'pt) {' +
            '#content {' +
                'min-width: ' + width + 'pt;' +
                'width: min-content;' +
                'width: -moz-min-content;' +
                'width: -webkit-min-content;' +
            '}',
                head = document.head || document.getElementsByTagName('head')[0],
                style = document.createElement('style');

            style.type = 'text/css';
            if (style.styleSheet){
              style.styleSheet.cssText = css;
            } else {
              style.appendChild(document.createTextNode(css));
            }

            head.appendChild(style);
            
            //Extract ID
            if (src.indexOf("/") !== -1) {
                var match = /https?:\/\/docs\.google\.com\/document\/d\/(.*?)\//.exec(src);
                var src = match[1];
            }
            
            //Fetch source
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        output(this.responseText);
                    } else {
                        output('<span class="message">Error loading document. Please refresh page.</span>');
                    }
                }
            };
            xhttp.open("GET", "https://docs.google.com/document/d/" + src + "/mobilebasic", true);
            xhttp.send();
        }
        
        function output(output) {
            //Wrap in page div
            output = "<div class='page'>" + output + "</div>";
        
            //Get title
            var match = /<title>(.*?)<\/title>/.exec(output);
            if (match) document.title = match[1];
            
            //Set image resolution to maximum
            output = output.replace(/(src="https?:\/\/.*?\.googleusercontent\.com\/.*?)=.*?"/gi, '$1=s6000"');
            
            //Set target to new tabindex
            output = output.replace(/href="/gi, 'target="_blank" href="');
            
            //Swap out google links
            var match = /(.*src=).*?((?:&|$).*)/.exec(document.location.href);
            output = output.replace(/href="[^>]*?https?:\/\/docs\.google\.com\/document\/d\/(.*?)(?:\/|%26)[^>]*?"/gi, 'href="' + match[1] + '$1' + match[2] + '"');
            
            //Remove pagebreaks
            output = output.replace(/<hr style="page-break-before:always;display:none;">/gi, (GET('merge') === '1') ? '' : '</div></div></div></div><div class="page"><div class="app-container"><div class="doc-container"><div class="doc">');

            //Fix HR
            output = output.replace(/<hr><p[^>]*?><span[^>]*?><\/span><\/p>/gi, "<hr>");
            output = output.replace(/<hr>/gi, "<div class='hr'></div>");
            
            //Collapse whitespace
            if (GET('collapse') === '1') {
                output = output.replace(/(<(p|h1|h2|h3|h4)[^>]*?><span[^>]*?><\/span><\/(p|h1|h2|h3|h4)>){2,8}/gi, "$1");
            }
            
            document.getElementById("content").innerHTML = output;
        }
    </script>
</head>
<body onload="fetch()">
<a target="_blank" class="edit">&#8599;</a>
<div id="content"><div class="page"><span class="message">Loading . . .</span></div></p>
</body>
</html>