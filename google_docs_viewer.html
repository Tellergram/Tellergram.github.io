<!DOCTYPE html>
<html>
<head>
    <title>Document Viewer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="normalize.css">
    <style>
        body {
            background-color: #EEE;
        }
        .app-container {
            margin-top: 0px !important;
            overflow-y: visible !important;
        }
        
        .doc {
            padding: 20px !important;
        }

        #content {
            margin: 0 auto;
            overflow: hidden;
        }
        
        .row {
            margin: 0 -10pt;
            text-align: center;
        }
        
        .page {
            display: inline-block;
            vertical-align: top;
            box-shadow: rgba(0, 0, 0, 0.28) 0px 0px 9px 0px;
            background-color: #FFF;
            margin: 10pt;
        }
        
        img {
            max-width: 100%;
            height: initial !important;
        }
        
        span {
            width: initial !important;
            height: initial !important;
        }
        
        .hr {
            border-bottom: .75pt solid #888;
            margin: 7pt 0;
        }
        
        .message {
            display: block;
            height: 100vh;
            line-height:100vh;
            text-align:center;
        }
        
        .edit {
            position: fixed;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            background-color: rgba(136, 136, 136, 0.5);
            color: #FFF;
            top: 0;
            right: 0;
            border-radius: 0px 0px 0px 10px;
            -moz-border-radius: 0px 0px 0px 10px;
            -webkit-border-radius: 0px 0px 0px 10px;
            border: 0px solid #000000;
            text-decoration: none;
            z-index: 10;
        }
        
        .edit:hover {
            background-color: rgba(52, 91, 138, 0.5);
        }
        
        .pagebreak {
            height: 1px;
            background-color: #F00;
        }
        #ruler {
            height: 1pt;
            position: absolute;
            visibility: none;
        }
    </style>
    <script>
        viewer_options = {
            src: null,
            width: 550,
            height: null,
            columns: 1,
            merge: 0,
            collapse: 0
        }
        
        for (var property in viewer_options) {
            if (viewer_options.hasOwnProperty(property)) {
                var re = new RegExp(property + '=([^&#=]*)'),
                    match = re.exec(window.location.search);
                if (match) viewer_options[property] = decodeURIComponent(match[1]);
            }
        }
        
        function getOffset( el ) {
            var _y = 0;
            while( el && !isNaN( el.offsetTop ) ) {
                _y += el.offsetTop - el.scrollTop;
                el = el.offsetParent;
            }
            return _y;
        }
    
        function fetch() {            
            //Set width and height
            var head = document.head || document.getElementsByTagName('head')[0],
                style = document.createElement('style'),
                css = '@media screen and (min-width: ' + viewer_options['width'] + 'pt) {' +
                '.page {' +
                    'min-width: ' + viewer_options['width'] + 'pt;' +
                    'width: min-content;' +
                    'width: -moz-min-content;' +
                    'width: -webkit-min-content;' +
                '}';
            if (viewer_options['height'] !== null) {
                css = css + '.page{ min-height: ' + viewer_options['height'] + 'pt }';
            }

            style.type = 'text/css';
            if (style.styleSheet){
              style.styleSheet.cssText = css;
            } else {
              style.appendChild(document.createTextNode(css));
            }

            head.appendChild(style);

            //Get source
            if (viewer_options['src'] == null) return output('<span class="message">Error reading "src" parameter in URL.</span>');

            if (viewer_options['src'].indexOf("/") !== -1) {
                var match = /https?:\/\/docs\.google\.com\/document\/d\/(.*?)\//.exec(viewer_options['src']);
                viewer_options['src'] = match[1];
            }            

            //Set edit button
            document.getElementsByClassName("edit")[0].setAttribute("href", "https://docs.google.com/document/d/" + viewer_options['src'] + "/edit");
            
            //Fetch source
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        output(this.responseText);
                    } else {
                        output('<span class="message">Error loading document. Please refresh page.</span>');
                    }
                }
            };
            xhttp.open("GET", "https://docs.google.com/document/d/" + viewer_options['src'] + "/mobilebasic", true);
            xhttp.send();
        }
        
        function output(output) {
            //Wrap in page div
            output = '<div class="row"><div class="page">' + output + '</div></div>';
        
            //Get title
            var match = /<title>(.*?)<\/title>/.exec(output);
            if (match) document.title = match[1];
            
            //Set image resolution to maximum
            output = output.replace(/(src="https?:\/\/.*?\.googleusercontent\.com\/.*?)=.*?"/gi, '$1=s6000"');
            
            //Set target to new tabindex
            output = output.replace(/href="([^#])/gi, 'target="_blank" href="$1');
            
            //Swap out google links
            var match = /(.*src=).*?((?:&|$).*)/.exec(document.location.href);
            output = output.replace(/href="[^>]*?https?:\/\/docs\.google\.com\/document\/d\/(.*?)(?:\/|%26)[^>]*?"/gi, 'href="' + match[1] + '$1' + match[2] + '"');
            
            //Remove pagebreaks
            output = output.replace(/<hr style="page-break-before:always;display:none;">/gi, (viewer_options['merge'] === '1') ? '' : '<div class="pagebreak"></div>');

            //Fix HR
            output = output.replace(/<hr><p[^>]*?><span[^>]*?><\/span><\/p>/gi, "<hr>");
            output = output.replace(/<hr>/gi, "<div class='hr'></div>");
            
            //Collapse whitespace
            if (viewer_options['collapse'] === '1') {
                output = output.replace(/(<(p|h1|h2|h3|h4)[^>]*?><span[^>]*?><\/span><\/(p|h1|h2|h3|h4)>){2,8}/gi, "$1");
            }
            
            //Render Output
            document.getElementById("content").innerHTML = output;
            
            //Fix Table Margins
            var elements = document.getElementsByTagName("table");
            for(var i = 0, max = elements.length; i < max; i++) {
                if (elements[i].style.marginLeft[0] == "-") {
                    elements[i].style.marginLeft = "0";
                }
            }
            
            //Pagebreaks
            if (viewer_options['height'] !== null) {
                var doc = document.getElementsByClassName("doc")[0],
                    elements = doc.childNodes,
                    ruler = document.getElementById('ruler').getBoundingClientRect(),
                    multiplier = ruler['bottom'] - ruler['top'],
                    pointer = getOffset(elements[0]),
                    page = 0;

                for(var i = 1, max = elements.length; i < max; i++) {
                    var y = getOffset(elements[i]);
                    
                    if (elements[i].className == "pagebreak") {
                        var pagebreak = elements[i];
                        pointer = y;
                        page++;
                    } else if ((y - pointer) / multiplier > viewer_options['height']) {
                        var pagebreak = document.createElement('div');
                        pagebreak.className = 'pagebreak';
                        doc.insertBefore(pagebreak, elements[i]);
                        
                        pointer = y;
                        page++;
                    }
                    
                    if (page >= viewer_options['columns']) {
                        pagebreak.className = 'rowbreak';
                        page = 0;
                    }
                }
            }
            output = document.getElementById("content").innerHTML;
            
            output = output.replace(/<div [^>]*?rowbreak[^>]*?><\/div>/gi, '</div></div></div></div></div><div class="row"><div class="page"><div class="app-container"><div class="doc-container"><div class="doc">');
            
            output = output.replace(/<div [^>]*?pagebreak[^>]*?><\/div>/gi, '</div></div></div></div><div class="page"><div class="app-container"><div class="doc-container"><div class="doc">');
            
            document.getElementById("content").innerHTML = output;
            
        }
    </script>
</head>
<body onload="fetch()">
<div id="ruler"></div>
<a target="_blank" class="edit">&#8599;</a>
<div id="content">
    <div class="row">
        <div class="page">
            <span class="message">Loading . . .</span>
        </div>
    </div>
</div>
</body>
</html>