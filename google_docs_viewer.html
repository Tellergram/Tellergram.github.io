<!DOCTYPE html>
<html>
<head>
    <title>Document Viewer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="normalize.css">
    <style>
        body {
            background-color: #EEE;
        }
        .app-container {
            margin-top: 0px !important;
            overflow-y: visible !important;
        }
        
        .doc {
            padding: 20pt !important;
        }

        #content {
            margin: 0 auto;
            overflow: hidden;
        }
        
        .row {
            margin: 0 -10pt;
            text-align: center;
        }
        
        .page {
            display: inline-block;
            vertical-align: top;
            box-shadow: rgba(0, 0, 0, 0.28) 0px 0px 9px 0px;
            margin: 10pt;
            max-width: calc(100% - 20pt);
            box-sizing: border-box;
        }
        
        img {
            max-width: 100%;
            height: initial !important;
        }
        
        span {
            width: initial !important;
            height: initial !important;
        }
        
        .hr {
            border-bottom: .75pt solid #888;
            margin: 7pt 0;
        }
        
        .message {
            width: 550pt;
            max-width: 100%;
            background-color: #FFF;
            height: 100vh;
            line-height:100vh;
            text-align:center;
        }
        
        .edit {
            position: fixed;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            background-color: rgba(136, 136, 136, 0.5);
            color: #FFF;
            top: 0;
            right: 0;
            border-radius: 0px 0px 0px 10px;
            -moz-border-radius: 0px 0px 0px 10px;
            -webkit-border-radius: 0px 0px 0px 10px;
            border: 0px solid #000000;
            text-decoration: none;
            z-index: 10;
        }
        
        .edit:hover {
            background-color: rgba(52, 91, 138, 0.5);
        }
        
        .pagebreak {
            height: 1px;
            margin-bottom: -1px;
            background-color: #F00;
        }
        
        .rowbreak {
            height: 1px;
            margin-bottom: -1px;
            background-color: #00F;
        }
        
        #ruler {
            height: 1pt;
            position: absolute;
            visibility: none;
        }
    </style>
    <script>
        (function() {
            function GoogleDocViewerAppFactory() {
                var app = {
                    api_key: "AIzaSyD1EsDgMLhcZZ-aiENeqppgtsLfYxr3gp8",
                    content: null,
                    options: {
                        src: null,
                        width: 550,
                        height: null,
                        columns: 1,
                        merge: 0,
                        collapse: 0,
                        background: "#FFF"
                    },
                    loaded: {
                        src: false,
                        formatting: false
                    },
                    decodeHtml: function(html) {
                        var txt = document.createElement("textarea");
                        txt.innerHTML = html;
                        return txt.value;
                    },
                    getYOffset: function( el ) {
                        var _y = 0;
                        while( el && !isNaN( el.offsetTop ) ) {
                            _y += el.offsetTop - el.scrollTop;
                            el = el.offsetParent;
                        }
                        return _y;
                    },
                    init: function() {
                        //Get options from URL
                        for (var property in app.options) {
                            if (app.options.hasOwnProperty(property)) {
                                var re = new RegExp(property + '=([^&#=]*)'),
                                    match = re.exec(window.location.search);
                                if (match) app.options[property] = decodeURIComponent(match[1]);
                            }
                        }
                            
                        //Get source
                        if (app.options['src'] == null) return output('<span class="message">Error reading "src" parameter in URL.</span>');

                        if (app.options['src'].indexOf("/") !== -1) {
                            var match = /https?:\/\/docs\.google\.com\/document\/d\/(.*?)\//.exec(app.options['src']);
                            app.options['src'] = match[1];
                        }
                        
                        //Set edit button
                        document.getElementsByClassName("edit")[0].setAttribute("href", "https://docs.google.com/document/d/" + app.options['src'] + "/edit");
                    
                        //Fetch source
                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function() {
                            if (this.readyState == 4) {
                                if (this.status == 200) {
                                    app.content = this.responseText;
                                    app.loaded.src = true;
                                    app.render();
                                } else {
                                    app.output('<div class="message">Error loading document. Please refresh page.</div>');
                                }
                            }
                        };
                        xhttp.open("GET", "https://docs.google.com/document/d/" + app.options['src'] + "/mobilebasic", true);
                        xhttp.send();
                        
                        //Fetch formatting
                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function() {
                            if (this.readyState == 4) {
                                if (this.status == 200) {
                                    var data = JSON.parse(this.responseText)['description'];
                                    
                                    for (var property in app.options) {
                                        if (app.options.hasOwnProperty(property)) {
                                            var re = new RegExp(property + '=([^&,=]*)'),
                                                match = re.exec(data);
                                            if (match) app.options[property] = decodeURIComponent(match[1]);
                                        }
                                    }
                                    app.loaded.formatting = true;
                                    app.render();
                                    
                                } else if (this.status == 403) {
                                    app.output('<div class="message">Error loading document style. Rendering anyway...</div>');
                                    setTimeout(function() {
                                        app.loaded.formatting = true;
                                        app.render();
                                    }, 1000);
                                } else {
                                    app.output('<div class="message">Error loading document style. Please refresh page.</div>');
                                }
                            }
                        };
                        xhttp.open("GET", "https://www.googleapis.com/drive/v2/files/" + app.options['src'] + "?key=" + app.api_key, true);
                        xhttp.send();
                    },
                    render: function() {
                        if (app.loaded.src && app.loaded.formatting) {
                            app.output(app.content);
                            app.content = null;
                        }
                    },
                    output: function(output) {
                        //Wrap in page div
                        output = '<div class="row"><div class="page">' + output + '</div></div>';
                    
                        //Get title
                        var match = /<title>(.*?)<\/title>/.exec(output);
                        if (match) document.title = app.decodeHtml(match[1]);
                        
                        //Set image resolution to maximum
                        output = output.replace(/(src="https?:\/\/.*?\.googleusercontent\.com\/.*?)=.*?"/gi, '$1=s6000"');
                        
                        //Set target to new tabindex
                        output = output.replace(/href="([^#])/gi, 'target="_blank" href="$1');
                        
                        //Swap out google links
                        var match = /(.*src=).*?((?:&|$).*)/.exec(document.location.href);
                        output = output.replace(/href="[^>]*?https?:\/\/docs\.google\.com\/document\/d\/(.*?)(?:\/|%26)[^>]*?"/gi, 'href="' + match[1] + '$1' + match[2] + '"');
                        
                        //Remove pagebreaks
                        output = output.replace(/<hr style="page-break-before:always;display:none;">/gi, (app.options['merge'] === '1') ? '' : '<div class="pagebreak"></div>');
                        
                        //Fix Non-Breaking Spaces
                        output = output.replace(/&nbsp;/gi, "&#8200;");
                        output = output.replace(/Â /gi, "&#8200;"); // Non-breaking space character
                        
                        //Fix HR
                        output = output.replace(/<hr><p[^>]*?><span[^>]*?><\/span><\/p>/gi, "<hr>");
                        output = output.replace(/<hr>/gi, "<div class='hr'></div>");
                        
                        //Collapse whitespace
                        if (app.options['collapse'] === '1') {
                            output = output.replace(/(<(p|h1|h2|h3|h4)[^>]*?><span[^>]*?><\/span><\/(p|h1|h2|h3|h4)>){2,8}/gi, "$1");
                        }
                        
                        //Render Output
                        document.getElementById("content").innerHTML = output;
                        
                        //Fix Table Margins
                        var elements = document.getElementsByTagName("table");
                        for(var i = 0, max = elements.length; i < max; i++) {
                            if (elements[i].style.marginLeft[0] == "-") {
                                elements[i].style.marginLeft = "0";
                            }
                        }
                        
                        //Pagebreaks
                        var doc = document.getElementsByClassName("doc")[0];
                        
                        if (doc) {
                            var elements = Array.from(doc.children),
                                ruler = document.getElementById('ruler').getBoundingClientRect(),
                                multiplier = ruler['bottom'] - ruler['top'],
                                pointer = app.getYOffset(elements[0]),
                                page = 0;

                            for(var i = 1, max = elements.length; i < max; i++) {
                                var y = app.getYOffset(elements[i]),
                                    d = elements[i].getBoundingClientRect()
                                    pagebreak = null;
                                
                                if (elements[i].className == "pagebreak") {
                                    var pagebreak = elements[i];
                                    pointer = y;
                                    page++;
                                } else if (app.options['height'] !== null && (y + d['bottom'] - d['top'] - pointer) / multiplier > app.options['height']) {
                                    var pagebreak = document.createElement('div');
                                    pagebreak.className = 'pagebreak';
                                    doc.insertBefore(pagebreak, elements[i]);
                                    
                                    pointer = y;
                                    page++;
                                }
                                
                                if (pagebreak && page >= app.options['columns']) {
                                    pagebreak.className = 'rowbreak';
                                    page = 0;
                                }
                            }
                        }
                        output = document.getElementById("content").innerHTML;
                        
                        output = output.replace(/<div [^>]*?rowbreak[^>]*?><\/div>/gi, '</div></div></div></div></div><div class="row"><div class="page"><div class="app-container"><div class="doc-container"><div class="doc">');
                        
                        output = output.replace(/<div [^>]*?pagebreak[^>]*?><\/div>/gi, '</div></div></div></div><div class="page"><div class="app-container"><div class="doc-container"><div class="doc">');
                        
                        document.getElementById("content").innerHTML = output;
                        
                        //Set width, height, and background
                        var head = document.head || document.getElementsByTagName('head')[0],
                            style = document.createElement('style'),
                            css = '@media screen and (min-width: ' + app.options['width'] + 'pt) {' +
                            '.page {' +
                                'min-width: ' + app.options['width'] + 'pt;' +
                                'width: ' + app.options['width'] + 'pt;' +
                                'width: min-content;' +
                                'width: -moz-min-content;' +
                                'width: -webkit-min-content;' +
                            '}}' +
                            '.page {' +
                                'background-color: ' + app.options['background'] + ';' +
                                ((app.options['height'] !== null) ? 'min-height: ' + app.options['height'] + 'pt;' : '') +
                            '}';

                        style.type = 'text/css';
                        if (style.styleSheet){
                          style.styleSheet.cssText = css;
                        } else {
                          style.appendChild(document.createTextNode(css));
                        }

                        head.appendChild(style);
                        
                        //Scroll to Hash
                        var hash = window.location.hash;
                        window.location.hash = "";
                        window.location.hash = hash;
                    }
                }
                
                return app;
            }
            GoogleDocViewerApp = GoogleDocViewerAppFactory();
        }())
    </script>
</head>
<body onload="GoogleDocViewerApp.init()">
<div id="ruler"></div>
<a target="_blank" class="edit">&#8599;</a>
<div id="content">
    <div class="row">
        <div class="page">
            <div class="message">Loading . . .</div>
        </div>
    </div>
</div>
</body>
</html>